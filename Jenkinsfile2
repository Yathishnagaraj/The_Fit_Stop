pipeline {
    agent any
    
    parameters {
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag to deploy')
        string(name: 'CONTAINER_PORT', defaultValue: '3000', description: 'Container internal port')
        string(name: 'HOST_PORT', defaultValue: '80', description: 'Host port to expose')
    }
    
    environment {
        IMAGE_NAME = 'yathish047/fitstopweb'
        CONTAINER_NAME = 'fitstop-app'
    }
    
    stages {
        stage('Stop Old Container') {
            steps {
                script {
                    sh '''
                        docker stop ${CONTAINER_NAME} 2>/dev/null || true
                        docker rm ${CONTAINER_NAME} 2>/dev/null || true
                    '''
                }
            }
        }
        
        stage('Pull Image') {
            steps {
                script {
                    sh "docker pull ${IMAGE_NAME}:${params.IMAGE_TAG}"
                }
            }
        }
        
        stage('Run Container') {
            steps {
                script {
                    sh """
                        docker run -d \
                        --name ${CONTAINER_NAME} \
                        -p ${params.HOST_PORT}:${params.CONTAINER_PORT} \
                        --restart unless-stopped \
                        ${IMAGE_NAME}:${params.IMAGE_TAG}
                    """
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    sh "docker ps | grep ${CONTAINER_NAME}"
                    echo "✅ Container is running on port ${params.HOST_PORT}"
                }
            }
        }
        
        stage('Cleanup Old Images') {
            steps {
                script {
                    sh 'docker image prune -f'
                }
            }
        }
    }
    
    post {
        success {
            echo "✅ Deployment successful!"
            echo "Access your app at: http://<your-server-ip>:${params.HOST_PORT}"
        }
        failure {
            echo "❌ Deployment failed!"
        }
    }
}
